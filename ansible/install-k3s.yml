---
- name: Install K3s Cluster
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    k3s_version: v1.28.5+k3s1  # Stable version
    k3s_token: "{{ lookup('password', '/tmp/k3s_token chars=ascii_letters,digits length=32') }}"
    cluster_cidr: "10.42.0.0/16"
    service_cidr: "10.43.0.0/16"
    
  tasks:
    - name: Display node information
      debug:
        msg: "Installing K3s on {{ inventory_hostname }} ({{ ansible_host }})"

- name: Prepare all nodes
  hosts: k3s_cluster
  become: yes
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      apt:
        name:
          - curl
          - apt-transport-https
          - ca-certificates
          - software-properties-common
        state: present
      when: ansible_os_family == "Debian"

    - name: Disable swap
      shell: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '\sswap\s'
        state: absent

    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes

    - name: Enable bridge netfilter
      modprobe:
        name: br_netfilter
        state: present

    - name: Make br_netfilter persistent
      lineinfile:
        path: /etc/modules-load.d/k3s.conf
        line: br_netfilter
        create: yes

    - name: Configure bridge netfilter
      sysctl:
        name: "{{ item }}"
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables

    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ ansible_host }} {{ inventory_hostname }}"
        state: present

- name: Install K3s on first master node
  hosts: k3s_masters[0]
  become: yes
  
  vars:
    k3s_version: v1.28.5+k3s1
    k3s_token: "{{ lookup('password', '/tmp/k3s_token chars=ascii_letters,digits length=32') }}"
  
  tasks:
    - name: Download K3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: '0755'

    - name: Install K3s first server (with cluster-init)
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        K3S_TOKEN={{ k3s_token }} \
        sh /tmp/k3s-install.sh server \
          --cluster-init \
          --write-kubeconfig-mode=644 \
          --disable=traefik \
          --disable=servicelb
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for K3s to be ready
      wait_for:
        port: 6443
        delay: 10
        timeout: 300

    - name: Wait for node to be ready
      shell: k3s kubectl wait --for=condition=Ready node/{{ inventory_hostname }} --timeout=300s
      register: node_ready
      until: node_ready.rc == 0
      retries: 10
      delay: 10

    - name: Get K3s token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_file

    - name: Save K3s token
      set_fact:
        k3s_node_token: "{{ k3s_token_file.content | b64decode | trim }}"

    - name: Display K3s token
      debug:
        msg: "K3s Token: {{ k3s_node_token }}"

    - name: Get kubeconfig
      slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_content

    - name: Save kubeconfig to local machine
      copy:
        content: "{{ kubeconfig_content.content | b64decode | regex_replace('127.0.0.1', ansible_host) }}"
        dest: "{{ playbook_dir }}/kubeconfig.yaml"
        mode: '0600'
      delegate_to: localhost

    - name: Display cluster info
      shell: k3s kubectl cluster-info
      register: cluster_info

    - name: Show cluster info
      debug:
        var: cluster_info.stdout_lines

- name: Install K3s on additional master nodes (HA)
  hosts: k3s_masters[1:]
  become: yes
  serial: 1
  
  vars:
    k3s_version: v1.28.5+k3s1
  
  tasks:
    - name: Get first master node IP
      set_fact:
        k3s_master_ip: "{{ hostvars[groups['k3s_masters'][0]]['ansible_host'] }}"
        k3s_node_token: "{{ hostvars[groups['k3s_masters'][0]]['k3s_node_token'] }}"

    - name: Download K3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: '0755'

    - name: Install K3s additional server (join to cluster)
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        K3S_URL=https://{{ k3s_master_ip }}:6443 \
        K3S_TOKEN={{ k3s_node_token }} \
        sh /tmp/k3s-install.sh server \
          --write-kubeconfig-mode=644 \
          --disable=traefik \
          --disable=servicelb
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for K3s to be ready
      wait_for:
        port: 6443
        delay: 10
        timeout: 300

- name: Verify K3s cluster
  hosts: k3s_masters[0]
  become: yes
  
  tasks:
    - name: Wait for all nodes to be ready
      shell: k3s kubectl get nodes -o json | jq -r '.items[] | select(.status.conditions[] | select(.type=="Ready" and .status=="True")) | .metadata.name' | wc -l
      register: ready_nodes
      until: ready_nodes.stdout | int == groups['k3s_cluster'] | length
      retries: 20
      delay: 10

    - name: Get cluster nodes
      shell: k3s kubectl get nodes -o wide
      register: nodes_output

    - name: Display nodes
      debug:
        var: nodes_output.stdout_lines

    - name: Get cluster pods
      shell: k3s kubectl get pods -A
      register: pods_output

    - name: Display pods
      debug:
        var: pods_output.stdout_lines

- name: Post-installation instructions
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Display success message
      debug:
        msg: |
          ========================================
          K3s Installation Complete!
          ========================================
          
          Kubeconfig saved to: {{ playbook_dir }}/kubeconfig.yaml
          
          To use kubectl locally:
          export KUBECONFIG={{ playbook_dir }}/kubeconfig.yaml
          kubectl get nodes
          
          Or copy to default location:
          mkdir -p ~/.kube
          cp {{ playbook_dir }}/kubeconfig.yaml ~/.kube/config
          
          Master node: {{ groups['k3s_masters'][0] }}
          Worker nodes: {{ groups['k3s_workers'] | join(', ') }}
